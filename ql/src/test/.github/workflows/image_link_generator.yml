name: Image URL Processing

on:
  issue_comment:
    types: [created]

jobs:
  process-image-url:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, 'https://github.com/github/release-assets/assets/')
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Extract and Clean Initial URL
        id: extract-url
        env:
          BODY: ${{ github.event.comment.body }}
        run: |
          INITIAL_URL=$(echo "$BODY" | grep -o 'https://github.com/github/release-assets/assets/[^ >]*')
          echo "Cleaned Initial URL: $INITIAL_URL"
          echo "::set-output name=initial_url::$INITIAL_URL"

      - name: Get Redirected URL with Debugging
        id: curl
        env:
          INITIAL_URL: ${{ steps.extract-url.outputs.initial_url }}
        run: |
          REDIRECTED_URL=$(curl -L -o /dev/null -w %{url_effective} -sS "$INITIAL_URL")
          echo "Curl Command Executed"
          echo "Redirected URL: $REDIRECTED_URL"
          echo "::set-output name=redirected_url::$REDIRECTED_URL"

      - name: Trim URL after PNG
        id: trim-url
        env:
          REDIRECTED_URL: ${{ steps.curl.outputs.redirected_url }}
        run: |
          TRIMMED_URL=$(echo "$REDIRECTED_URL" | sed 's/\(.*\.png\).*/\1/')
          echo "Trimmed URL: $TRIMMED_URL"
          echo "::set-output name=trimmed_url::$TRIMMED_URL"

      - name: Update Comment with New URL
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_URL: ${{ github.event.comment.url }}
          ORIGINAL_COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          NEW_COMMENT_BODY="Use this link to include this asset in your changelog: ${{ steps.trim-url.outputs.trimmed_url }}"
          UPDATED_COMMENT="${ORIGINAL_COMMENT_BODY} ðŸ‘€ ${NEW_COMMENT_BODY}"

          PAYLOAD=$(jq -n --arg body "$UPDATED_COMMENT" '{"body": $body}')
          curl -X PATCH \
               -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "${COMMENT_URL}" \
               -d "$PAYLOAD"
