name: Argument injection

on:
  pull_request_target:

jobs:
  test1:
    runs-on: ubuntu-latest
    env:
      TITLE: ${{github.event.pull_request.title}}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      - run: echo "s/FOO/$TITLE/g"
      - run: sed "s/FOO/$TITLE/g"
      - run: echo "foo" | sed "s/FOO/$TITLE/g" > bar
      - run: echo $(echo "foo" | sed "s/FOO/$TITLE/g" > bar)
      - run: awk "BEGIN {$TITLE}"
      - run: sed -i "s/git_branch = .*/git_branch = \"$GITHUB_HEAD_REF\"/" config.json
      - run: |
          sed -i "s|git_branch = .*|git_branch = \"$GITHUB_HEAD_REF\"|" config.json
      - run: |
          sed -e 's#<branch_to_sync>#${TITLE}#' \
              -e 's#<sot_repo>#${{ env.sot_repo }}#' \
              -e 's#<destination_repo>#TITLE#' \
              .github/workflows/common-copybara.bara.sky.template > .github/workflows/common-copybara.bara.sky
      - run: |
          sed -e 's#<branch_to_sync>#TITLE#' \
              -e 's#<sot_repo>#${{ env.sot_repo }}#' \
              -e 's#<destination_repo>#${TITLE}#' \
              .github/workflows/common-copybara.bara.sky.template > .github/workflows/common-copybara.bara.sky
      - run: |
          BODY=$(git log --format=%s)
          sed "s/FOO/$BODY/g" > /tmp/foo

      - name: Checkout ref
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Detect new changesets
        id: added-files
        run: |
          delimiter="$(openssl rand -hex 8)"
          echo "changesets<<${delimiter}" >> "${GITHUB_OUTPUT}"
          echo "$(git diff --name-only --diff-filter=A ${{ steps.comment-branch.outputs.base_sha }} ${{ steps.parse-sha.outputs.sha }} .changeset/*.md)" >> "${GITHUB_OUTPUT}"
          echo "${delimiter}" >> "${GITHUB_OUTPUT}"
